<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8" />
    <title>Listing</title>

    <style>
        body{
          margin:0;
          min-height:100vh;
          font-family:"Segoe UI", Arial, sans-serif;
          background-image:url("/images/login.jpg");
          background-size:cover;
          background-position:center;
          display:flex;
          justify-content:center;
          align-items:center;
        }

        .container{
          width:90%;
          max-width:1200px;
          padding:25px;
          padding-top:85px;
          background:rgba(255,255,255,0.15);
          backdrop-filter:blur(10px);
          border-radius:12px;
          box-shadow:0 0 25px rgba(0,0,0,0.3);
          color:white;
          position:relative;
        }

        .navbar{
          position:absolute;
          top:0; left:0; right:0;
          display:flex;
          justify-content:space-between;
          align-items:center;
          padding:14px 22px;
          box-sizing:border-box;
          background:rgba(0,0,0,0.25);
          backdrop-filter:blur(8px);
          border-radius:12px 12px 0 0;
        }

        .brand-link{display:flex;align-items:center;gap:12px;text-decoration:none;}
        .logo{
          height:44px;width:auto;object-fit:contain;display:block;
          filter:drop-shadow(0 6px 14px rgba(0,0,0,0.35));
        }
        .brand-text{display:flex;flex-direction:column;line-height:1.05;}
        .brand-name{
          font-size:18px;font-weight:900;letter-spacing:0.6px;color:#fff;
          text-shadow:0 2px 10px rgba(0,0,0,0.35);
        }
        .brand-accent{color:#2fa4f5;}
        .brand-tagline{
          margin-top:3px;font-size:11.5px;font-weight:600;letter-spacing:0.2px;
          color:rgba(255,255,255,0.75);
        }

        .nav-right{display:flex;align-items:center;gap:10px;flex-wrap:wrap;}
        .nav-link{
          padding:8px 14px;border-radius:6px;text-decoration:none;color:white;
          background-color:#2fa4f5;display:inline-block;font-size:14px;
        }
        .nav-link:hover{background-color:#1e88e5;}
        .nav-link.secondary{background-color:#7f8c8d;}
        .nav-link.secondary:hover{background-color:#6c7a7b;}
        .nav-link-green{
          padding:8px 14px;border-radius:6px;text-decoration:none;color:white;
          background-color:#27ae60;display:inline-block;font-size:14px;
        }
        .nav-link-green:hover{background-color:#1f8f4d;}
        .nav-btn{
          padding:8px 14px;border-radius:6px;border:none;cursor:pointer;
          color:white;background-color:#e74c3c;font-size:14px;
        }
        .nav-btn:hover{background-color:#c0392b;}

        .topbar{
          display:flex;
          align-items:center;
          gap:10px;
          margin:0 0 14px 0;
          color:rgba(255,255,255,0.9);
        }
        .back-link{
          display:inline-flex;
          align-items:center;
          gap:10px;
          text-decoration:none;
          color:rgba(255,255,255,0.9);
          font-weight:700;
        }
        .back-link:hover{color:#fff;text-decoration:underline;}

        .listing-layout{
          display:grid;
          grid-template-columns: 1.35fr 0.85fr;
          gap:18px;
          align-items:start;
        }
        @media (max-width: 980px){
          .listing-layout{grid-template-columns:1fr; }
        }

        .gallery{
          background:rgba(0,0,0,0.22);
          border:1px solid rgba(255,255,255,0.14);
          border-radius:14px;
          overflow:hidden;
          box-shadow:0 12px 30px rgba(0,0,0,0.35);
        }

        .gallery-main{
          position:relative;
          height:420px;
          background:rgba(0,0,0,0.25);
        }
        @media (max-width: 980px){
          .gallery-main{height:360px;}
        }

        /* IMPORTANT: keep image under arrows */
        .gallery-main img{
          width:100%;
          height:100%;
          object-fit:cover;
          display:block;
          position:relative;
          z-index:1;
        }

        .nav-arrow{
          position:absolute;
          top:50%;
          transform:translateY(-50%);
          width:42px;height:42px;
          border-radius:999px;
          border:1px solid rgba(255,255,255,0.22);
          background:rgba(0,0,0,0.35);
          color:white;
          cursor:pointer;
          display:flex;
          align-items:center;
          justify-content:center;
          user-select:none;
          font-weight:900;
          font-size:18px;
          backdrop-filter: blur(6px);
          z-index:9999;         /* IMPORTANT */
          pointer-events:auto;  /* IMPORTANT */
        }
        .nav-arrow:hover{background:rgba(0,0,0,0.5);}
        .nav-arrow.left{left:12px;}
        .nav-arrow.right{right:12px;}

        .gallery-thumbs{
          display:flex;
          gap:10px;
          padding:12px;
          overflow:auto;
          background:rgba(0,0,0,0.25);
          border-top:1px solid rgba(255,255,255,0.12);
        }
        .thumb{
          width:86px;
          height:56px;
          flex:0 0 auto;
          border-radius:10px;
          overflow:hidden;
          border:2px solid rgba(255,255,255,0.14);
          cursor:pointer;
          opacity:0.85;
        }
        .thumb img{width:100%;height:100%;object-fit:cover;display:block;}
        .thumb.active{
          border-color: rgba(47,164,245,0.95);
          opacity:1;
        }

        .info-card{
          background:rgba(20, 24, 35, 0.92);
          border-radius:16px;
          padding:18px 18px 16px 18px;
          box-shadow:0 15px 40px rgba(0,0,0,0.4);
          border:1px solid rgba(255,255,255,0.12);
        }

        .title{font-size:22px;font-weight:900;margin:0 0 4px 0;letter-spacing:0.2px;}
        .subtitle{margin:0 0 14px 0;color:rgba(255,255,255,0.78);font-weight:600;font-size:13px;line-height:1.35;}

        .price-row{
          display:flex;align-items:baseline;justify-content:space-between;gap:12px;
          margin:10px 0 14px 0;padding-bottom:12px;border-bottom:1px solid rgba(255,255,255,0.14);
        }
        .price{font-size:28px;font-weight:900;color:#ffffff;}
        .price small{font-size:14px;font-weight:800;color:rgba(255,255,255,0.7);margin-left:6px;}
        .badge{
          font-size:12px;font-weight:800;padding:6px 10px;border-radius:999px;
          background:rgba(39, 174, 96, 0.18);
          border:1px solid rgba(39, 174, 96, 0.35);
          color:#b7ffd0;white-space:nowrap;
        }

        .seller{
          margin:12px 0 10px 0;padding:12px;border-radius:12px;
          background:rgba(255,255,255,0.06);
          border:1px solid rgba(255,255,255,0.12);
        }
        .seller .name{font-weight:900;margin-bottom:4px;}
        .seller .meta{color:rgba(255,255,255,0.75);font-size:13px;margin:3px 0;}

        .primary-action{margin-top:12px;display:flex;flex-direction:column;gap:10px;}
        .btn-primary{
          width:100%;border:none;border-radius:12px;padding:12px 14px;font-weight:900;
          cursor:pointer;color:white;background:#ff3c00;font-size:14px;
        }
        .btn-primary:hover{background:#e63200;}

        .btn-row{display:flex;gap:10px;}
        .btn-outline{
          flex:1;border-radius:12px;padding:11px 12px;cursor:pointer;font-weight:800;font-size:13px;
          border:1px solid rgba(140, 103, 255, 0.55);
          color:#d9ccff;background:rgba(140,103,255,0.10);
        }
        .btn-outline:hover{
          background:rgba(140,103,255,0.18);
          border-color: rgba(140, 103, 255, 0.8);
        }

        .details{
          margin-top:14px;background:rgba(0,0,0,0.18);
          border:1px solid rgba(255,255,255,0.14);
          border-radius:14px;padding:14px;
        }
        .detail-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px 12px;}
        @media (max-width: 980px){ .detail-grid{grid-template-columns:1fr;} }
        .kv{padding:10px 12px;border-radius:12px;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.12);}
        .k{font-size:12px;font-weight:900;color:rgba(255,255,255,0.75);margin-bottom:4px;}
        .v{font-size:14px;font-weight:800;color:#fff;word-break:break-word;}

        .desc{
          margin-top:12px;padding:12px;border-radius:14px;background:rgba(255,255,255,0.06);
          border:1px solid rgba(255,255,255,0.12);
          color:rgba(255,255,255,0.88);line-height:1.45;font-size:14px;white-space:pre-line;
        }

        .tag{
          display:inline-block;padding:4px 10px;border-radius:999px;font-size:12px;
          background:rgba(47,164,245,0.15);
          color:#bfe4ff;border:1px solid rgba(47,164,245,0.30);
          margin-top:10px;font-weight:900;
        }

        .tech-card{
          margin-top: 14px;
          background: rgba(20, 24, 35, 0.92);
          border-radius: 16px;
          padding: 16px;
          box-shadow: 0 15px 40px rgba(0,0,0,0.4);
          border: 1px solid rgba(255,255,255,0.12);
        }
        .tech-title{
          font-size: 18px;font-weight: 900;margin: 0 0 12px 0;letter-spacing: 0.2px;color: #fff;
        }
        .tech-grid{display: grid;grid-template-columns: 1fr;gap: 10px;}
        .tech-row{
          display: grid;grid-template-columns: 0.95fr 1.35fr;gap: 14px;align-items: center;
          padding: 12px 12px;border-radius: 12px;
          background: rgba(255,255,255,0.06);border: 1px solid rgba(255,255,255,0.10);
        }
        .tech-row:nth-child(even){background: rgba(255,255,255,0.045);}
        .tech-k{font-size: 13px;font-weight: 900;color: rgba(255,255,255,0.75);}
        .tech-v{font-size: 13.5px;font-weight: 800;color: rgba(255,255,255,0.95);word-break: break-word;}
        @media (max-width: 560px){
          .tech-row{grid-template-columns: 1fr;gap: 6px;}
        }
    </style>
</head>

<body>
<div class="container">

    <!-- NAVBAR -->
    <div class="navbar">
        <div class="nav-left">
            <a th:href="@{/marketplace}" class="brand-link">
                <img src="/images/logo3.png" alt="AutoLix Logo" class="logo" />
                <div class="brand-text">
                    <div class="brand-name">Auto<span class="brand-accent">Lix</span></div>
                    <div class="brand-tagline">Marketplace auto • anunțuri verificate</div>
                </div>
            </a>
        </div>

        <div class="nav-right">
            <div sec:authorize="hasAnyRole('ADMIN','EDITOR')">
                <a class="nav-link" th:href="@{/masini}">Database</a>
            </div>

            <a class="nav-link" th:href="@{/marketplace}">Marketplace</a>

            <a class="nav-link"
               sec:authorize="isAuthenticated()"
               th:href="@{/my-profile}">My Profile</a>

            <a class="nav-link-green"
               sec:authorize="isAuthenticated()"
               th:href="@{/masini/add}">+ Add Listing</a>

            <a class="nav-link"
               sec:authorize="isAnonymous()"
               th:href="@{/login}">Login</a>

            <a class="nav-link secondary"
               sec:authorize="isAnonymous()"
               th:href="@{/signup}">Sign up</a>

            <form sec:authorize="isAuthenticated()"
                  th:action="@{/logout}"
                  method="post"
                  style="margin:0;">
                <button type="submit" class="nav-btn">Logout</button>
            </form>
        </div>
    </div>

    <!-- BACK -->
    <div class="topbar">
        <a class="back-link" th:href="@{/marketplace}">
            ← Înapoi la lista cu rezultatele căutării
        </a>
    </div>

    <div class="listing-layout">
        <!-- LEFT: GALLERY -->
        <div class="gallery">
            <div class="gallery-main">
                <img id="mainImg"
                     th:src="${(images != null and !#lists.isEmpty(images)) ? '/uploads/' + images[0] : (m.imageName != null ? '/uploads/' + m.imageName : '/images/no-image.png')}"
                     alt="Car photo"/>

                <!-- INLINE onclick: guaranteed -->
                <div class="nav-arrow left" onclick="prevImg()" aria-label="Prev">‹</div>
                <div class="nav-arrow right" onclick="nextImg()" aria-label="Next">›</div>
            </div>

            <!-- THUMBS -->
            <div class="gallery-thumbs" id="thumbs">
                <!-- multiple images -->
                <div class="thumb"
                     th:if="${images != null and !#lists.isEmpty(images)}"
                     th:each="img, it : ${images}"
                     th:classappend="${it.index == 0} ? ' active' : ''"
                     th:attr="data-src=${'/uploads/' + img}"
                     onclick="pickImg(this)">
                    <img th:src="${'/uploads/' + img}" alt="thumb"/>
                </div>

                <!-- fallback single image -->
                <div class="thumb active"
                     th:if="${images == null or #lists.isEmpty(images)}"
                     th:attr="data-src=${m.imageName != null ? '/uploads/' + m.imageName : '/images/no-image.png'}"
                     onclick="pickImg(this)">
                    <img th:src="${m.imageName != null ? '/uploads/' + m.imageName : '/images/no-image.png'}" alt="thumb"/>
                </div>
            </div>

            <!-- TECH SPECS -->
            <div class="tech-card">
                <div class="tech-title">Date tehnice</div>
                <div class="tech-grid">

                    <div class="tech-row">
                        <div class="tech-k">Marcă</div>
                        <div class="tech-v" th:text="${m.marca}">—</div>
                    </div>

                    <div class="tech-row">
                        <div class="tech-k">Model</div>
                        <div class="tech-v" th:text="${m.modelul}">—</div>
                    </div>

                    <div class="tech-row">
                        <div class="tech-k">An</div>
                        <div class="tech-v" th:text="${m.anul}">—</div>
                    </div>

                    <div class="tech-row">
                        <div class="tech-k">Kilometraj</div>
                        <div class="tech-v"
                             th:text="${m.kilometraj != null ? #numbers.formatInteger(m.kilometraj, 0, 'POINT') + ' km' : '—'}">—</div>
                    </div>

                    <div class="tech-row">
                        <div class="tech-k">Combustibil</div>
                        <div class="tech-v" th:text="${m.combustibil}">—</div>
                    </div>

                    <div class="tech-row">
                        <div class="tech-k">Culoare</div>
                        <div class="tech-v" th:text="${m.culoarea}">—</div>
                    </div>

                    <div class="tech-row">
                        <div class="tech-k">Capacitate cilindrică</div>
                        <div class="tech-v"
                             th:text="${m.capacitatea_cilindrica != null ? #numbers.formatInteger(m.capacitatea_cilindrica, 0, 'POINT') + ' ccm' : '—'}">—</div>
                    </div>

                    <div class="tech-row">
                        <div class="tech-k">Putere</div>
                        <div class="tech-v"
                             th:text="${m.puterea != null ? m.puterea + ' CP' : '—'}">—</div>
                    </div>

                    <div class="tech-row">
                        <div class="tech-k">Cuplu</div>
                        <div class="tech-v"
                             th:text="${m.cuplul != null ? m.cuplul + ' Nm' : '—'}">—</div>
                    </div>

                    <div class="tech-row">
                        <div class="tech-k">Volum portbagaj</div>
                        <div class="tech-v"
                             th:text="${m.volumul_portbagajului != null ? m.volumul_portbagajului + ' L' : '—'}">—</div>
                    </div>

                    <div class="tech-row">
                        <div class="tech-k">Preț</div>
                        <div class="tech-v"
                             th:text="${m.pretul != null ? #numbers.formatInteger(m.pretul, 0, 'POINT') + ' €' : '—'}">—</div>
                    </div>

                    <div class="tech-row">
                        <div class="tech-k">Număr înmatriculare</div>
                        <div class="tech-v" th:text="${m.nr_inmatriculare}">—</div>
                    </div>

                </div>
            </div>
        </div>

        <!-- RIGHT: INFO -->
        <div>
            <div class="info-card">
                <div class="title" th:text="${m.marca + ' ' + m.modelul}">—</div>

                <div class="subtitle">
                    <span th:text="${m.anul}">—</span>
                    <span> • </span>
                    <span th:text="${m.kilometraj != null ? #numbers.formatInteger(m.kilometraj, 0, 'POINT') + ' km' : '—'}">—</span>
                    <span> • </span>
                    <span th:text="${m.combustibil}">—</span>
                    <span> • </span>
                    <span th:text="${m.puterea != null ? m.puterea + ' CP' : '—'}">—</span>
                </div>

                <div class="price-row">
                    <div class="price">
                        <span th:text="${m.pretul != null ? #numbers.formatInteger(m.pretul, 0, 'POINT') : '—'}">—</span>
                        <small>EUR</small>
                    </div>
                    <div class="badge">Preț foarte bun</div>
                </div>

                <div class="seller">

                        <div class="name"
                             th:text="'Vânzător: ' + (${m.utilizator != null && m.utilizator.nume != null ? m.utilizator.nume : (m.utilizator != null ? m.utilizator.username : 'Anonim')})">
                            Vânzător
                        </div>

                    <div class="meta" th:text="${sellerCity != null ? sellerCity : ''}"></div>
                    <div class="meta" th:if="${phone != null}">
                        Telefon: <span th:text="${phone}">—</span>
                    </div>
                </div>

                <div class="primary-action">
                    <a th:href="${sellerEmail != null ? 'mailto:' + sellerEmail + '?subject=' + (m.marca + ' ' + m.modelul) : '#'}"
                       style="text-decoration:none;">
                        <button class="btn-primary" type="button">✉ Scrie un e-mail</button>
                    </a>

                    <div class="btn-row">
                        <button class="btn-outline" type="button" onclick="toggleFav()">♡ Parcare</button>
                        <button class="btn-outline" type="button" onclick="shareListing()">⤴ Partajează</button>
                    </div>

                    <div style="margin-top:10px; color:rgba(255,255,255,0.65); font-size:12.5px;">
                        ID anunț:
                        <span th:text="${m.nr_inmatriculare}">—</span>
                    </div>
                </div>

                <span class="tag" th:text="${m.anul}">—</span>
            </div>

            <div class="details">
                <div class="detail-grid">
                    <div class="kv">
                        <div class="k">Kilometraj</div>
                        <div class="v" th:text="${m.kilometraj != null ? #numbers.formatInteger(m.kilometraj, 0, 'POINT') + ' km' : '—'}">—</div>
                    </div>

                    <div class="kv">
                        <div class="k">Cuplu</div>
                        <div class="v" th:text="${m.cuplul != null ? m.cuplul + ' Nm' : '—'}">—</div>
                    </div>

                    <div class="kv">
                        <div class="k">Culoare</div>
                        <div class="v" th:text="${m.culoarea}">—</div>
                    </div>

                    <div class="kv">
                        <div class="k">Combustibil</div>
                        <div class="v" th:text="${m.combustibil}">—</div>
                    </div>

                    <div class="kv">
                        <div class="k">Putere</div>
                        <div class="v" th:text="${m.puterea != null ? m.puterea + ' CP' : '—'}">—</div>
                    </div>

                    <div class="kv">
                        <div class="k">An</div>
                        <div class="v" th:text="${m.anul}">—</div>
                    </div>
                </div>



            </div>
        </div>
    </div>

</div>

<script>
    // All functions are global => inline onclick can call them

    function getThumbs() {
      return Array.from(document.querySelectorAll('#thumbs .thumb'));
    }

    function setActiveThumb(el) {
      getThumbs().forEach(t => t.classList.remove('active'));
      if (el) el.classList.add('active');
    }

    function pickImg(el) {
      if (!el) return;
      const src = el.getAttribute('data-src');
      const main = document.getElementById('mainImg');
      if (src && main) main.src = src;
      setActiveThumb(el);
    }

    function currentIndex() {
      const thumbs = getThumbs();
      const idx = thumbs.findIndex(t => t.classList.contains('active'));
      return idx >= 0 ? idx : 0;
    }

    function nextImg() {
      const thumbs = getThumbs();
      if (!thumbs.length) return;
      let i = currentIndex();
      i = (i + 1) % thumbs.length;
      pickImg(thumbs[i]);
    }

    function prevImg() {
      const thumbs = getThumbs();
      if (!thumbs.length) return;
      let i = currentIndex();
      i = (i - 1 + thumbs.length) % thumbs.length;
      pickImg(thumbs[i]);
    }

    function shareListing() {
      const url = window.location.href;
      if (navigator.share) {
        navigator.share({ title: document.title, url });
      } else {
        navigator.clipboard?.writeText(url);
        alert("Link copiat în clipboard.");
      }
    }

    function toggleFav() {
      alert("Funcția de favorite: leag-o la endpoint-ul tău.");
    }
</script>
</body>
</html>
